name: Publish Web SDK - Build and publish @moor/web-sdk NPM package

on:
  push:
    branches:
      - main
    paths:
      - 'clients/web-sdk/**'
  workflow_dispatch:

jobs:
  publish_web_sdk:
    runs-on: ubuntu-latest
    container: node:20-bookworm
    steps:
      - uses: https://code.forgejo.org/actions/checkout@v4

      - name: Configure NPM registry
        working-directory: clients/web-sdk
        run: |
          echo "@moor:registry=https://codeberg.org/api/packages/timbran/npm/" > .npmrc
          echo "//codeberg.org/api/packages/timbran/npm/:_authToken=${{ secrets.CODEBERG_TOKEN }}" >> .npmrc

      - name: Install dependencies
        working-directory: clients/web-sdk
        run: npm install

      - name: Use dev schema dependency
        working-directory: clients/web-sdk
        run: npm install --no-save @moor/schema@dev

      - name: Typecheck
        working-directory: clients/web-sdk
        run: npm run typecheck

      - name: Publish to Codeberg Package Registry
        working-directory: clients/web-sdk
        run: |
          set -eu
          REGISTRY="https://codeberg.org/api/packages/timbran/npm/"
          BASE_VERSION=$(node -p "require('./package.json').version")
          SHORT_SHA="$(echo '${{ github.sha }}' | cut -c1-8)"
          DEV_VERSION="${BASE_VERSION}-dev.$(date -u +%Y%m%d%H%M%S%N).${{ github.run_id }}.${SHORT_SHA}"
          echo "Publishing version $DEV_VERSION"

          npm pkg set dependencies.@moor/schema=dev
          npm version "$DEV_VERSION" --no-git-tag-version

          PUBLISH_LOG="$(mktemp)"
          if npm publish --tag dev >"$PUBLISH_LOG" 2>&1; then
            cat "$PUBLISH_LOG"
            rm -f "$PUBLISH_LOG"
            exit 0
          fi

          cat "$PUBLISH_LOG"
          if grep -q "E409" "$PUBLISH_LOG" && npm view "@moor/web-sdk@$DEV_VERSION" version --registry="$REGISTRY" >/dev/null 2>&1; then
            echo "Publish returned 409 but version exists in registry; treating as success"
            rm -f "$PUBLISH_LOG"
            exit 0
          fi

          rm -f "$PUBLISH_LOG"
          exit 1
