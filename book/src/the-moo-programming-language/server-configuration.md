# Server Configuration

This section discusses the options for compiling and running the server that can affect the database and how the code within it runs.

## Server Compilation Options

The following option values are specified (via #define) in the file `options.h` in the server sources. Except for those cases where property values on $server_options take precedence, these settings cannot be changed at runtime.

This list is not intended to be exhaustive.
Network Options

| Option                   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| NETWORK_PROTOCOL         | This specifies the underlying protocol for the server to use for all connections and will be one of the following:<br> `NP_TCP` The server uses TCP/IP protocols. <br> `NP_LOCAL` The server uses local interprocess communication mechanisms (currently either BSD UNIX-domain sockets or SYSV named pipes).<br> `NP_SINGLE` The server accepts only a single `connection` via the standard input and output streams of the server itself. Attempts to have multiple simultaneous listening points (via listen() will likewise fail. |
| DEFAULT_PORT             | (for NP_TCP) the TCP port number on which the server listens when no port-number argument is given on the command line.                                                                                                                                                                                                                                                                                                                                                                                                               |
| DEFAULT_CONNECT_FILE     | (for NP_LOCAL) the local filename through which the server will listen for connections when no connect-file-name is given on the command line.                                                                                                                                                                                                                                                                                                                                                                                        |
| OUTBOUND_NETWORK         | The server will include support for open_network_connection() if this constant is defined. If given a zero value, the function will be disabled by default and `-o` will need to be specified on the command line in order to enable it, otherwise (nonzero or blank value) the function is enabled by default and `-O` will needed to disable it. When disabled or not supported, open_network_connection() raises E_PERM whenever it is called. The NETWORK_PROTOCOL must be NP_TCP.                                                |
| MAX_QUEUED_OUTPUT        | The maximum number of output characters the server is willing to buffer for any given network connection before discarding old output to make way for new. This can be overridden in-database by adding the property `$server_options.max_queued_output` and calling `load_server_options()`.                                                                                                                                                                                                                                         |
| MAX_QUEUED_INPUT         | The maximum number of input characters the server is willing to buffer from any given network connection before it stops reading from the connection at all.                                                                                                                                                                                                                                                                                                                                                                          |
| IGNORE_PROP_PROTECTED    | Disables protection of builtin properties via $server_options.protect_property when set. See section Protected Properties.                                                                                                                                                                                                                                                                                                                                                                                                            |
| OUT_OF_BAND_PREFIX       | Specifies the out-of-band prefix. If this is defined as a non-empty string, then any lines of input from any player that begin with that prefix will not be consumed by reading tasks and will not undergo normal command parsing. See section Out-of-band Processing.                                                                                                                                                                                                                                                                |
| OUT_OF_BAND_QUOTE_PREFIX | Specifies the out-of-band quoting prefix. If this is defined as a non-empty string, then any lines of input from any player that begin with that prefix will have that prefixed stripped and the resulting string will bypass Out-of-Band Processing.                                                                                                                                                                                                                                                                                 |
| DEFAULT_MAX_STACK_DEPTH  | Default value for $server_options.max_stack_depth.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| DEFAULT_FG_TICKS         | The number of ticks allotted to foreground tasks. Default value for $server_options.fg_ticks.                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| DEFAULT_BG_TICKS         | The number of ticks allotted to background tasks. Default value for $server_options.bg_ticks.                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| DEFAULT_FG_SECONDS       | The number of seconds allotted to foreground tasks. Default value for $server_options.fg_seconds.                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| DEFAULT_BG_SECONDS       | The number of seconds allotted to background tasks. Default value for $server_options.bg_seconds.                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| DEFAULT_CONNECT_TIMEOUT  | Default value for $server_options.connect_timeout.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| LOG_CODE_CHANGES         | Write to the log file who changed what verb code.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| USE_ANCESTOR_CACHE       | Determine if the server should cache the ancestors of objects to improve performance of property lookups.                                                                                                                                                                                                                                                                                                                                                                                                                             |
| OWNERSHIP_QUOTA          | Control whether or not the server's default ownership quota management is enabled or not. It defaults to disabled to allow the database to handle quota on its own.                                                                                                                                                                                                                                                                                                                                                                   |
| UNSAFE_FIO               | This allows you to skip the character by character line verification for a small performance boost. Make sure to read the disclaimer above it in options.h.                                                                                                                                                                                                                                                                                                                                                                           |
| LOG_EVALS                | Allow all evals to be written to the server log.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| MEMO_STRLEN              | Improve performance of string comparisons by using the pre-computed length of strings to rule out equality before doing a character by character comparison.                                                                                                                                                                                                                                                                                                                                                                          |
| NO_NAME_LOOKUP           | When enabled, the server won't attempt to perform a DNS name lookup on any new connections.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| INCLUDE_RT_VARS          | Allow for retrieval of runtime environment variables from a running task, unhandled exceptions or timeouts, and lagging tasks via `handle_uncaught_error`, `handle_task_timeout`, and `handle_lagging_task`, respectively. To control automatic inclusion of runtime environment variables, set the INCLUDE_RT_VARS server option. Variables will be added to the end of the stack frame as a map.                                                                                                                                    |
| PCRE_PATTERN_CACHE_SIZE  | Specifies how many PCRE patterns are cached.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| SAFE_RECYCLE             | Change ownership of everything an object owns before recycling it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| DEFAULT_THREAD_MODE      | Set the default thread mode for threaded functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| TOTAL_BACKGROUND_THREADS | Number of threads created at runtime.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| SAVE_FINISHED_TASKS      | Enabled the `finished_tasks` function and define how many tasks get saved by default.                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| DEFAULT_LAG_THRESHOLD    | The number of seconds allowed before a task is considered laggy and triggers `#0:handle_lagging_task`.                                                                                                                                                                                                                                                                                                                                                                                                                                |
| MAX_LINE_BYTES           | Unceremoniously close connections that send lines exceeding this value to prevent memory allocation panics.                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ONLY_32_BITS             | Switch from 64bits back to 32bits.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| CURL_TIMEOUT             | Specify the maximum amount of time a CURL request can take before failing.                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

## Running the Server

The server command line has the following general form:

`./moo [-e] [-f script-file] [-c script-line] [-l log-file] [-m] [-w waif-type] [-O|-o] [-4 ipv4-address] [-6 ipv6-address] [-r certificate-path] [-k key-path] [-i files-path] [-x executables-path] input-db-file output-db-file [-t|-p port-number]`

| Option             | Description                                                                     |
| ------------------ | ------------------------------------------------------------------------------- |
| -v, --version      | current version                                                                 |
| -h, --help         | show usage information and command-line options                                 |
| -e, --emergency    | emergency wizard mode                                                           |
| -l, --log          | redirect standard output to log file                                            |
| -m, --clear-move   | clear the `last_move' builtin property on all objects                           |
| -w, --waif-type    | convert waifs from the specified type (check with typeof(waif) in your old MOO) |
| -f, --start-script | file to load and pass to `#0:do_start_script()'                                 |
| -c, --start-line   | line to pass to `#0:do_start_script()'                                          |
| -i, --file-dir     | directory to look for files for use with FileIO functions                       |
| -x, --exec-dir     | directory to look for executables for use with the exec() function              |
| -o, --outbound     | enable outbound network connections                                             |
| -O, --no-outbound  | disable outbound network connections                                            |
| -4, --ipv4         | restrict IPv4 listeners to a specific address                                   |
| -6, --ipv6         | restrict IPv6 listeners to a specific address                                   |
| -r, --tls-cert     | TLS certificate to use                                                          |
| -k, --tls-key      | TLS key to use                                                                  |
| -t, --tls-port     | port to listen for TLS connections on (can be used multiple times)              |
| -p, --port         | port to listen for connections on (can be used multiple times)                  |

The emergency mode switch (-e) may not be used with either the file (-f) or line (-c) options.

Both the file and line options may be specified. Their order on the command line determines the order of their invocation.

Examples:
./moo -c '$enable_debugging();' -f development.moo Minimal.db Minimal.db.new 7777
./moo Minimal.db Minimal.db.new

> Note: A full list of arguments is now available by supplying `--help`.

> Note: For both the -c and -f arguments, the script content is passed in the args built-in variable. The server makes no assumptions about the semantics of the script; the interpretation of the script is the verb`s responsibility. Like Emergency Wizard Mode, the verb is called before starting any tasks or doing the initial listen to accept connections.
