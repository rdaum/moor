# Enrollment Token Secret
# This secret stores the enrollment token used by hosts and workers to register with the daemon.
# The token should be generated once and shared across all components.
#
# To generate a token manually:
#   kubectl create secret generic moor-enrollment-token \
#     --from-literal=token=$(uuidgen) \
#     -n moor
#
# Or use the init-enrollment Job below to auto-generate on first deployment

---
apiVersion: batch/v1
kind: Job
metadata:
  name: init-enrollment-token
  namespace: moor
  labels:
    app.kubernetes.io/name: moor
    app.kubernetes.io/component: init
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: moor
        app.kubernetes.io/component: init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: generate-token
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              # Check if secret already exists
              if kubectl get secret moor-enrollment-token -n moor &>/dev/null; then
                echo "Enrollment token secret already exists, skipping generation"
                exit 0
              fi

              # Generate UUID as enrollment token
              TOKEN=$(cat /proc/sys/kernel/random/uuid)

              # Create secret
              kubectl create secret generic moor-enrollment-token \
                --from-literal=token="$TOKEN" \
                -n moor

              echo "Enrollment token generated successfully"
          env:
            - name: HOME
              value: /tmp
      serviceAccountName: moor-init
---
# ServiceAccount for the init job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: moor-init
  namespace: moor
  labels:
    app.kubernetes.io/name: moor
    app.kubernetes.io/component: init
---
# Role allowing the init job to create secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: moor-init
  namespace: moor
  labels:
    app.kubernetes.io/name: moor
    app.kubernetes.io/component: init
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create"]
---
# RoleBinding for init ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: moor-init
  namespace: moor
  labels:
    app.kubernetes.io/name: moor
    app.kubernetes.io/component: init
subjects:
  - kind: ServiceAccount
    name: moor-init
    namespace: moor
roleRef:
  kind: Role
  name: moor-init
  apiGroup: rbac.authorization.k8s.io
