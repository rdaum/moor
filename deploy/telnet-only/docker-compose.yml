# Telnet-only production deployment for mooR
# This configuration runs only the core daemon and telnet host, without web components.
# Uses IPC (Unix domain sockets) for inter-process communication since both services run on the same host.
# Suitable for traditional MUD/MOO usage via telnet clients.

networks:
  moor_net:

# Named volumes for persistent application data
# Note: moor-config uses a bind mount instead of a named volume
# to avoid permission issues with non-root users
#volumes:

services:
  # The core Moor daemon, which handles the database, scheduling and execution of tasks, and hosts the RPC server.
  moor-daemon:
    # Use pre-built image from Codeberg registry
    image: codeberg.org/timbran/moor:latest-x86_64
    # To use locally-built images instead, replace the 'image:' line above with the 'build:' section below:
    # build:
    #   context: ../..
    #   target: backend
    #   network: host
    #   args:
    #     BUILD_PROFILE: release
    # For aarch64 systems, change 'latest-x86_64' to 'latest-aarch64'
    container_name: "moor-daemon"
    user: "${USER_ID}:${GROUP_ID}"
    environment:
      - RUST_BACKTRACE=1
      - HOME=/moor
      - XDG_CONFIG_HOME=/moor/.config
      - XDG_DATA_HOME=/moor/.local/share
    working_dir: /moor
    volumes:
      - ./moor-data:/moor/moor-data
      - ../../cores:/moor/cores:ro
      - ./moor-ipc:/var/run/moor
      - ./moor-config:/moor/.config/moor
      - ./moor-local-share:/moor/.local/share/moor
    command: >
      ./moor-daemon
        /moor/moor-data
        --db=production.db
        --rpc-listen=ipc:///var/run/moor/rpc.sock
        --events-listen=ipc:///var/run/moor/events.sock
        --generate-keypair
        --import=/moor/cores/lambda-moor/src --import-format=objdef
    networks:
      - moor_net
    restart: unless-stopped

  # A host process that runs the telnet server, and handles incoming connections and forwards events to the daemon.
  moor-telnet-host:
    # Use pre-built image from Codeberg registry
    image: codeberg.org/timbran/moor:latest-x86_64
    # To use locally-built images instead, replace the 'image:' line above with the 'build:' section below:
    # build:
    #   context: ../..
    #   target: backend
    #   network: host
    #   args:
    #     BUILD_PROFILE: release
    # For aarch64 systems, change 'latest-x86_64' to 'latest-aarch64'
    container_name: "moor-telnet-host"
    user: "${USER_ID}:${GROUP_ID}"
    environment:
      - RUST_BACKTRACE=1
      - HOME=/moor
      - XDG_CONFIG_HOME=/moor/.config
      - XDG_DATA_HOME=/moor/.local/share
    working_dir: /moor
    volumes:
      - ./moor-telnet-host-data:/moor/.moor-host-data
      - ./moor-ipc:/var/run/moor
      - ./moor-config:/moor/.config/moor:ro
      - ./moor-local-share:/moor/.local/share/moor:ro
    command:
      - ./moor-telnet-host
      - --telnet-address=0.0.0.0
      - --telnet-port=8888
      - --rpc-address=ipc:///var/run/moor/rpc.sock
      - --events-address=ipc:///var/run/moor/events.sock
    ports:
      # Telnet listener
      - "8888:8888"
    networks:
      - moor_net
    depends_on:
      moor-daemon:
        condition: service_started
    restart: unless-stopped
