# TCP/CURVE Enrollment Docker Compose Configuration for mooR
#
# This configuration is designed for:
#   - Testing TCP/CURVE enrollment flows
#   - Multi-machine deployment testing
#   - Development of distributed mooR setups
#
# ⚠️  NOT RECOMMENDED FOR PRODUCTION USE ⚠️
#
# For production deployments, see the deploy/ directory:
#   - deploy/telnet-only/     - Minimal telnet-only setup
#   - deploy/web-basic/       - Web-enabled (HTTP only)
#   - deploy/web-ssl/         - Web-enabled with HTTPS (recommended for production)
#   - deploy/debian-packages/ - Native Debian/Ubuntu packages with systemd
#   - deploy/kubernetes/      - Kubernetes manifests with health checks and horizontal scaling
#
# For simple single-host development, use docker-compose.yml (IPC-based)
#
# NOTE: This Docker Compose configuration runs all containers on a single host for testing.
# For a more realistic multi-machine clustered deployment example with health checks,
# readiness/liveness probes, and horizontal scaling, see deploy/kubernetes/
#
# This configuration uses debug builds by default for faster compilation during development.
# Production deployments should use release builds for better performance.

# The first time the system starts, it will import cores/lambda-moor from the cores directory.
# This is a fork of LambdaCore, reconstituted in mooR's `objdef` format, with some modifications.
# To import an existing LambdaMOO 1.8.x DB, change --import to point to it, and change --import-format to textdump
# After import, `moor-data` will contain the database that resulted.
# To re-import simply delete this directory.

# After this is running, a MUD client / telnet client can connect to port 8888 on localhost to interact with the
# system. (e.g. telnet localhost 8888). Or a websocket client can connect to port 8080 on localhost.

networks:
  # An internal network for the mooR system, to allow the different components to communicate with each other.
  # This configuration uses TCP sockets to demonstrate how mooR components would communicate in a distributed
  # multi-machine deployment, with CURVE encryption and enrollment tokens for security.
  moor_net:

services:
  # Initialization container to generate enrollment token if needed
  init-enrollment:
    image: alpine:latest
    container_name: "moor-init-enrollment"
    volumes:
      - moor-config:/root/.config/moor
    command: >
      sh -c "
        if [ ! -f /root/.config/moor/enrollment-token ]; then
          echo 'Generating enrollment token...' &&
          mkdir -p /root/.config/moor &&
          cat /proc/sys/kernel/random/uuid > /root/.config/moor/enrollment-token &&
          echo 'Enrollment token generated at /root/.config/moor/enrollment-token' &&
          :
        else
          echo 'Enrollment token already exists at /root/.config/moor/enrollment-token' &&
          :
        fi
      "
    networks:
      - moor_net

  # The core Moor daemon, which handles the database, scheduling and execution of tasks, and hosts the RPC server.
  moor-daemon:
    build:
      context: .
      target: backend
      network: host
      args:
        BUILD_PROFILE: ${BUILD_PROFILE:-debug}
    container_name: "moor-daemon"
    environment:
      - RUST_BACKTRACE=1
    working_dir: /moor
    volumes:
      - ./:/db
      - moor-config:/root/.config/moor
      - moor-allowed-hosts:/root/.local/share/moor/allowed-hosts
    command: >
      ./moor-daemon
        /db/moor-data
        --db=development.db
        --rpc-listen=tcp://0.0.0.0:7899
        --events-listen=tcp://0.0.0.0:7898
        --workers-response-listen=tcp://0.0.0.0:7897
        --workers-request-listen=tcp://0.0.0.0:7896
        --enrollment-listen=tcp://0.0.0.0:7900
        --generate-keypair
        --import=/db/cores/lambda-moor/src --import-format=objdef
        --export=/db/export --export-format objdef
    ports:
      # ZMQ ports
      - "7899:7899" # RPC listener
      - "7898:7898" # Events listener
      - "7897:7897" # Workers response listener
      - "7896:7896" # Workers request listener
      - "7900:7900" # Enrollment listener
    networks:
      - moor_net
    depends_on:
      init-enrollment:
        condition: service_completed_successfully

  # A host process that runs the telnet server, and handles incoming connections and forwards events to the daemon.
  moor-telnet-host:
    build:
      context: .
      target: backend
      network: host
      args:
        BUILD_PROFILE: ${BUILD_PROFILE:-debug}
    container_name: "moor-telnet-host"
    environment:
      - RUST_BACKTRACE=1
    working_dir: /moor
    volumes:
      - moor-config:/root/.config/moor:ro
      - ./moor-telnet-host-data:/moor/.moor-host-data
    command:
      - ./moor-telnet-host
      - --telnet-address=0.0.0.0
      - --telnet-port=8888
      - --rpc-address=tcp://moor-daemon:7899
      - --events-address=tcp://moor-daemon:7898
      - --enrollment-address=tcp://moor-daemon:7900
    ports:
      # Telnet listener
      - "8888:8888"
    networks:
      - moor_net
    depends_on:
      init-enrollment:
        condition: service_completed_successfully
      moor-daemon:
        condition: service_started

  # Frontend web server that serves static files and proxies API calls
  moor-frontend:
    build:
      context: .
      target: frontend
      network: host
    container_name: "moor-frontend"
    depends_on:
      - moor-web-host
    ports:
      # Main web interface
      - "8080:80"
    networks:
      - moor_net

  # API server that handles websocket connections and REST endpoints
  moor-web-host:
    build:
      context: .
      target: backend
      network: host
      args:
        BUILD_PROFILE: ${BUILD_PROFILE:-debug}
    container_name: "moor-web-host"
    environment:
      - RUST_BACKTRACE=1
    working_dir: /moor
    volumes:
      - moor-config:/root/.config/moor:ro
      - ./moor-web-host-data:/moor/.moor-host-data
    command:
      - ./moor-web-host
      - --listen-address=0.0.0.0:8081
      - --rpc-address=tcp://moor-daemon:7899
      - --events-address=tcp://moor-daemon:7898
      - --enrollment-address=tcp://moor-daemon:7900

    ports:
      # API listener (internal)
      - "8081:8081"
    networks:
      - moor_net
    depends_on:
      init-enrollment:
        condition: service_completed_successfully
      moor-daemon:
        condition: service_started

  # A worker process that handles requests from the daemon for outbound HTTP requests and returns the results back
  # to the daemon.
  moor-curl-worker:
    build:
      context: .
      target: backend
      network: host
      args:
        BUILD_PROFILE: ${BUILD_PROFILE:-debug}
    container_name: "moor-curl-worker"
    environment:
      - RUST_BACKTRACE=1
    working_dir: /moor
    volumes:
      - moor-config:/root/.config/moor:ro
      - ./moor-curl-worker-data:/moor/.moor-host-data
    command:
      - ./moor-curl-worker
      - --rpc-address=tcp://moor-daemon:7899
      - --events-address=tcp://moor-daemon:7898
      - --workers-request-address=tcp://moor-daemon:7896
      - --workers-response-address=tcp://moor-daemon:7897
      - --enrollment-address=tcp://moor-daemon:7900

    networks:
      - moor_net
    depends_on:
      init-enrollment:
        condition: service_completed_successfully
      moor-daemon:
        condition: service_started

volumes:
  moor-config:
  moor-allowed-hosts: