# Docker Compose override for tracing-enabled builds
# This file enables Chrome Trace Event Format tracing for performance diagnostics
#
# Usage (IPC development): docker compose -f docker-compose.yml -f docker-compose.tracing.yml up
# Usage (TCP cluster): docker compose -f docker-compose.cluster.yml -f docker-compose.tracing.yml up

services:
  moor-daemon:
    build:
      args:
        TRACE_EVENTS: true
    environment:
      - RUST_BACKTRACE=full
    volumes:
      # Mount a volume for trace output that's easily accessible
      - ./traces:/moor/traces
    command: >
      ./moor-daemon
        /db/moor-data
        --db=development.db
        --trace-output=/moor/traces/moor-trace.json
        --generate-keypair
        --import=/db/cores/lambda-moor/src --import-format=objdef
        --export=/db/export --export-format objdef

  moor-telnet-host:
    build:
      args:
        TRACE_EVENTS: true
    environment:
      - RUST_BACKTRACE=full

  moor-web-host:
    build:
      args:
        TRACE_EVENTS: true
    environment:
      - RUST_BACKTRACE=full

  moor-curl-worker:
    build:
      args:
        TRACE_EVENTS: true
    environment:
      - RUST_BACKTRACE=full

volumes:
  # Trace output volume - maps ./traces directory on host to /moor/traces in container
  traces:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./traces